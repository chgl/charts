# ohdsi

[OHDSI](https://github.com/OHDSI) - Helm chart for deploying OHDSI ATLAS and WebAPI.

## TL;DR;

```sh
helm repo add chgl https://chgl.github.io/charts
helm repo update
helm install ohdsi chgl/ohdsi -n ohdsi
```

## Breaking Changes

### 0.14

Updates all object labels to follow the Bitnami chart conventions: <https://github.com/bitnami/charts/blob/master/bitnami/common/templates/_labels.tpl>.

If you have installed a previous version and attempt to update, you will most likely receive something similar to the following message:

```console
Error: UPGRADE FAILED: cannot patch "ohdsi-atlas" with kind Deployment: Deployment.apps "ohdsi-atlas" is invalid: spec.selector:
Invalid value: v1.LabelSelector{MatchLabels:map[string]string{"app.kubernetes.io/component":"atlas", "app.kubernetes.io/instance":"ohdsi", "app.kubernetes.io/name":"ohdsi"},
MatchExpressions:[]v1.LabelSelectorRequirement(nil)}: field is immutable [...]
```

Unfortunately, the only solution is to delete and re-install the chart.
The following assumes that you have previously installed version `0.13.0`
of the chart in the `ohdsi` namespace and used the included PostgreSQL sub-chart:

```sh
$ helm ls -n ohdsi
NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
ohdsi   ohdsi           3               2022-04-03 22:21:13.8195241 +0200 CEST  deployed        ohdsi-0.13.0    2.10.1

# if not saved anywhere else, first retrieve the password used by the PostgreSQL sub-chart
export POSTGRES_PASSWORD=$(kubectl get secret --namespace ohdsi ohdsi-postgresql -o jsonpath="{.data.postgres-password}" | base64 --decode)

# if you depend on the data used by the PostgreSQL sub-chart, please make sure
# uninstalling the release doesn't automatically delete the PVC before running the following
$ helm uninstall -n ohdsi ohdsi
release "ohdsi" uninstalled

$ kubectl get pvc -n ohdsi
NAME                      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
data-ohdsi-postgresql-0   Bound    pvc-91614c49-cfe6-421a-8990-3317dfd88030   8Gi        RWO            standard       17m

# this uses the $POSTGRES_PASSWORD retrieved in the first step
# since we didn't rename the release, this will re-use the PVC `data-ohdsi-postgresql-0` used for the previous installation
helm upgrade --install -n ohdsi --render-subchart-notes --set postgresql.auth.postgresPassword="${POSTGRES_PASSWORD}" ohdsi charts/ohdsi/
```

### 0.12

Updates the included Bitnami PostgreSQL sub-chart to v11. The default Postgres version is now 14.2.

Steps to upgrade from an existing installation:

1. if you are using the sub-chart, either manually upgrade an existing postgres installation to v14.2 or set `postgresql.image.tag: 13.1.0`.
1. the default key name for the postgres secret has been renamed from `postgresql-password` to `postgres-password`. If you are using the `existingSecret` option, you may have to manually update accordingly.
1. if you are overriding any other of the sub-chart's values, please see <https://docs.bitnami.com/kubernetes/infrastructure/postgresql/administration/upgrade/> for instructions on upgrading.

### 0.4

Starting with v0.4.0, the two separate ingress resources for WebAPI and Atlas have been merged into a single one with the `/WebAPI/` and `/atlas/` paths
mapping to the WebAPI and Atlas service respectively. Set `ingress.enabled=true` and configure `ingress.hosts[]` to enabled it.

## Introduction

This chart deploys the OHDSI WebAPI and ATLAS app. on a [Kubernetes](http://kubernetes.io) cluster using the [Helm](https://helm.sh) package manager.

## Prerequisites

- Kubernetes v1.21+
- Helm v3

## Installing the Chart

To install the chart with the release name `ohdsi`:

```console
$ helm install ohdsi chgl/ohdsi -n ohdsi
```

The command deploys the OHDSI WebAPI and ATLAS app. on the Kubernetes cluster in the default configuration. The [configuration](#configuration) section lists the parameters that can be configured during installation.

> **Tip**: List all releases using `helm list`

## Uninstalling the Chart

To uninstall/delete the `ohdsi`:

```console
$ helm delete ohdsi -n ohdsi
```

The command removes all the Kubernetes components associated with the chart and deletes the release.

## Configuration

The following table lists the configurable parameters of the `ohdsi` chart and their default values.

| Parameter                                 | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Default                                                                                                                                                                               |
| ----------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| imagePullSecrets                          | image pull secrets used by all pods                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <code>[]</code>                                                                                                                                                                       |
| nameOverride                              | partially override the release name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <code>""</code>                                                                                                                                                                       |
| fullnameOverride                          | fully override the release name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | <code>""</code>                                                                                                                                                                       |
| commonAnnotations                         | annotations applied to all deployments and jobs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | <code>[]</code>                                                                                                                                                                       |
| postgresql.enabled                        | enable an included PostgreSQL DB. if set to `false`, the values under `webApi.db` are used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <code>true</code>                                                                                                                                                                     |
| postgresql.auth.database                  | name of the database to create see: <https://github.com/bitnami/bitnami-docker-postgresql/blob/master/README.md#creating-a-database-on-first-run>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <code>"ohdsi"</code>                                                                                                                                                                  |
| postgresql.auth.existingSecret            | Name of existing secret to use for PostgreSQL credentials `auth.postgresPassword`, `auth.password`, and `auth.replicationPassword` will be ignored and picked up from this secret The secret must contain the keys `postgres-password` (which is the password for "postgres" admin user), `password` (which is the password for the custom user to create when `auth.username` is set), and `replication-password` (which is the password for replication user). The secret might also contains the key `ldap-password` if LDAP is enabled. `ldap.bind_password` will be ignored and picked from this secret in this case. The value is evaluated as a template. | <code>""</code>                                                                                                                                                                       |
| postgresql.auth.enablePostgresUser        | Assign a password to the "postgres" admin user. Otherwise, remote access will be blocked for this user                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | <code>true</code>                                                                                                                                                                     |
| postgresql.auth.username                  | Name for a custom user to create                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <code>""</code>                                                                                                                                                                       |
| postgresql.auth.password                  | Password for the custom user to create                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | <code>""</code>                                                                                                                                                                       |
| postgresql.primary.initdb.scripts         | Dictionary of initdb scripts Specify dictionary of scripts to be run at first boot                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | <code>{}</code>                                                                                                                                                                       |
| webApi.enabled                            | enable the OHDSI WebAPI deployment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | <code>true</code>                                                                                                                                                                     |
| webApi.replicaCount                       | number of pod replicas for the WebAPI                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | <code>1</code>                                                                                                                                                                        |
| webApi.podDisruptionBudget.enabled        | create a PodDisruptionBudget resource for the OHDSI Atlas pods                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>false</code>                                                                                                                                                                    |
| webApi.podDisruptionBudget.minAvailable   | Minimum available instances; ignored if there is no PodDisruptionBudget                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <code>1</code>                                                                                                                                                                        |
| webApi.podDisruptionBudget.maxUnavailable | Maximum unavailable instances; ignored if there is no PodDisruptionBudget                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <code>""</code>                                                                                                                                                                       |
| webApi.db.host                            | database hostname                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <code>"host.example.com"</code>                                                                                                                                                       |
| webApi.db.port                            | port used to connect to the postgres DB                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <code>5432</code>                                                                                                                                                                     |
| webApi.db.database                        | name of the database inside. If postgresql.enabled=true, then postgresql.postgresqlDatabase is used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <code>"ohdsi"</code>                                                                                                                                                                  |
| webApi.db.username                        | username used to connect to the DB. Note that this name is currently used even if postgresql.enabled=true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <code>"postgres"</code>                                                                                                                                                               |
| webApi.db.password                        | the database password. Only used if postgresql.enabled=false, otherwise the secret created by the postgresql chart is used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <code>"postgres"</code>                                                                                                                                                               |
| webApi.db.existingSecret                  | name of an existing secret containing the password to the DB.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <code>""</code>                                                                                                                                                                       |
| webApi.db.existingSecretKey               | name of the key in `webApi.db.existingSecret` to use as the password to the DB.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | <code>"postgresql-postgres-password"</code>                                                                                                                                           |
| webApi.db.schema                          | schema used for the WebAPI's tables. Also referred to as the "OHDSI schema"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | <code>"ohdsi"</code>                                                                                                                                                                  |
| webApi.auth.openid.enabled                | enable securing the WebAPI via an OpenId connect provider. make sure to also configure `atlas.config.local` appropriately to enable the auth provider in ATLAS. See "[Securing Atlas using OpenID Connect](#securing-atlas-using-openid-connect)" below                                                                                                                                                                                                                                                                                                                                                                                                          | <code>false</code>                                                                                                                                                                    |
| webApi.auth.openid.oidUrl                 | Required. Points to the openid-configuration endpoint of the provider, e.g. `https://auth.example.com/auth/realms/OHDSI/.well-known/openid-configuration`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <code>""</code>                                                                                                                                                                       |
| webApi.auth.openid.clientId               | the client id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <code>""</code>                                                                                                                                                                       |
| webApi.auth.openid.clientSecret           | the client secret                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <code>""</code>                                                                                                                                                                       |
| webApi.auth.openid.existingSecret         | name of an existing Kubernetes secret containing the OpenId client secret                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <code>""</code>                                                                                                                                                                       |
| webApi.auth.openid.existingSecretKey      | name of the key inside the secret whose value is the OpenId client secret                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <code>"webapi-openid-client-secret"</code>                                                                                                                                            |
| webApi.auth.openid.callbackApi            | URL including the OHDSI WebAPI oauth callback, e.g. `https://example.com/WebAPI/user/oauth/callback`. If unset, a URL is constructed from `ingress.hosts[0]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <code>""</code>                                                                                                                                                                       |
| webApi.auth.openid.callbackUI             | URL including the callback URL referring to the ATLAS UI, e.g. `https://example.com/atlas/index.html#/welcome/`. If unset, a URL is constructed from `ingress.hosts[0]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <code>""</code>                                                                                                                                                                       |
| webApi.auth.openid.logoutUrl              | URL to be redirected to when logging out, e.g. `https://example.com/atlas/index.html#/welcome/`. If unset, a URL is constructed from `ingress.hosts[0]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <code>""</code>                                                                                                                                                                       |
| webApi.auth.openid.redirectUrl            | OpenID redirect URL, e.g. `https://example.com/atlas/index.html#/welcome/null` If unset, a URL is constructed from `ingress.hosts[0]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | <code>""</code>                                                                                                                                                                       |
| webApi.auth.basic.enabled                 | enable securing access to the WebAPI using basic security configuration. See <https://github.com/OHDSI/WebAPI/wiki/Basic-Security-Configuration> for details.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <code>false</code>                                                                                                                                                                    |
| webApi.auth.basic.schema                  | schema inside the database specified in `.Values.webApi.db` which contains tables used for querying basic security users. If unset, defaults to `.Values.webApi.db.schema`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | <code>""</code>                                                                                                                                                                       |
| webApi.auth.basic.query                   | SQL query used to fetch entries in the basic security table by their username. Requires a table called `basic_security_users` to exist within the above schema, see [webapi-enable-auth-values.yaml](ci/webapi-enable-auth-values.yaml) for an example DB setup. Evaluated as a template.                                                                                                                                                                                                                                                                                                                                                                        | <code>>-&#13;&#10; SELECT password, first_name AS firstname, middle_name AS middlename, last_name AS&#13;&#10; lastname, username FROM basic_security_users WHERE username = ?</code> |
| webApi.podAnnotations                     | annotations applied to the pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>{}</code>                                                                                                                                                                       |
| webApi.cors.enabled                       | whether CORS is enabled for the WebAPI. Sets the `security.cors.enabled` property.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | <code>false</code>                                                                                                                                                                    |
| webApi.cors.allowedOrigin                 | value of the `Access-Control-Allow-Origin` header. Sets the `security.origin` property. set to `*` to allow requests from all origins. if `cors.enabled=true`, `cors.allowedOrigin=""` and `ingress.enabled=true`, then `ingress.hosts[0].host` is used.                                                                                                                                                                                                                                                                                                                                                                                                         | <code>""</code>                                                                                                                                                                       |
| webApi.podSecurityContext                 | security context for the pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <code>{}</code>                                                                                                                                                                       |
| webApi.service                            | the service used to expose the WebAPI web port                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>{"port":8080,"type":"ClusterIP"}</code>                                                                                                                                         |
| webApi.resources                          | resource requests and limits for the container. <br> 2Gi+ of RAM are recommended (<https://github.com/OHDSI/WebAPI/issues/1811#issuecomment-792988811>) <br> You might also want to use `webApi.extraEnv` to set `MinRAMPercentage` and `MaxRAMPercentage`: <br> Example: <br> `helm template charts/ohdsi \` <br> `--set webApi.extraEnv[0].name="JAVA_OPTS" \` <br> `--set webApi.extraEnv[0].value="-XX:MinRAMPercentage=60.0 -XX:MaxRAMPercentage=80.0"`                                                                                                                                                                                                     | <code>{}</code>                                                                                                                                                                       |
| webApi.nodeSelector                       | node labels for pods assignment see: <https://kubernetes.io/docs/user-guide/node-selection/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <code>{}</code>                                                                                                                                                                       |
| webApi.tolerations                        | tolerations for pods assignment see: <https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>[]</code>                                                                                                                                                                       |
| webApi.affinity                           | affinity for pods assignment see: <https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <code>{}</code>                                                                                                                                                                       |
| webApi.topologySpreadConstraints          | pod topology spread configuration see: <https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/#api>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <code>[]</code>                                                                                                                                                                       |
| webApi.extraEnv                           | extra environment variables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | <code>[]</code>                                                                                                                                                                       |
| atlas.enabled                             | enable the OHDSI Atlas deployment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <code>true</code>                                                                                                                                                                     |
| atlas.replicaCount                        | number of replicas                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | <code>1</code>                                                                                                                                                                        |
| atlas.podDisruptionBudget.enabled         | create a PodDisruptionBudget resource for the OHDSI Atlas pods                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>false</code>                                                                                                                                                                    |
| atlas.podDisruptionBudget.minAvailable    | Minimum available instances; ignored if there is no PodDisruptionBudget                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <code>1</code>                                                                                                                                                                        |
| atlas.podDisruptionBudget.maxUnavailable  | Maximum unavailable instances; ignored if there is no PodDisruptionBudget                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <code>""</code>                                                                                                                                                                       |
| atlas.webApiUrl                           | the base URL of the OHDSI WebAPI, e.g. `https://example.com/WebAPI` if this value is not set but `ingress.enabled=true` and `constructWebApiUrlFromIngress=true`, then this URL is constructed from `ingress`                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <code>""</code>                                                                                                                                                                       |
| atlas.constructWebApiUrlFromIngress       | if enabled, sets the WebAPI URL to `http://ingress.hosts[0]/WebAPI`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <code>true</code>                                                                                                                                                                     |
| atlas.podAnnotations                      | annotations for the pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <code>{}</code>                                                                                                                                                                       |
| atlas.podSecurityContext                  | security context for the pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <code>{}</code>                                                                                                                                                                       |
| atlas.service                             | the service used to expose the Atlas web port                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <code>{"port":8080,"type":"ClusterIP"}</code>                                                                                                                                         |
| atlas.resources                           | resource requests and limits for the container                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>{}</code>                                                                                                                                                                       |
| atlas.nodeSelector                        | node labels for pods assignment see: <https://kubernetes.io/docs/user-guide/node-selection/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <code>{}</code>                                                                                                                                                                       |
| atlas.tolerations                         | tolerations for pods assignment see: <https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>[]</code>                                                                                                                                                                       |
| atlas.affinity                            | affinity for pods assignment see: <https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <code>{}</code>                                                                                                                                                                       |
| atlas.topologySpreadConstraints           | pod topology spread configuration see: <https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/#api>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <code>[]</code>                                                                                                                                                                       |
| atlas.extraEnv                            | extra environment variables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | <code>[]</code>                                                                                                                                                                       |
| atlas.config.local                        | this value is expected to contain the config-local.js contents                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>""</code>                                                                                                                                                                       |
| cdmInitJob.enabled                        | if enabled, create a Kubernetes Job running the specified container see [cdm-init-job.yaml](templates/cdm-init-job.yaml) for the env vars that are passed by default                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | <code>false</code>                                                                                                                                                                    |
| cdmInitJob.image                          | the container image used to create the CDM initialization job                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <code>{"pullPolicy":"IfNotPresent","registry":"docker.io","repository":"docker/whalesay","tag":"latest"}</code>                                                                       |
| cdmInitJob.backoffLimit                   | the number of retries before considering the Job as failed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <code>6</code>                                                                                                                                                                        |
| cdmInitJob.ttlSecondsAfterFinished        | clean up Job and dependent objects after job completion <https://kubernetes.io/docs/concepts/workloads/controllers/job/#ttl-mechanism-for-finished-jobs>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | <code>120</code>                                                                                                                                                                      |
| cdmInitJob.podAnnotations                 | annotations set on the cdm-init pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <code>{}</code>                                                                                                                                                                       |
| cdmInitJob.podSecurityContext             | PodSecurityContext for the cdm-init pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <code>{}</code>                                                                                                                                                                       |
| cdmInitJob.securityContext                | ContainerSecurityContext for the cdm-init container                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <code>{}</code>                                                                                                                                                                       |
| cdmInitJob.extraEnv                       | extra environment variables to set                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | <code>[]</code>                                                                                                                                                                       |
| achilles.enabled                          | whether or not to enable the Achilles cron job                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>true</code>                                                                                                                                                                     |
| achilles.schedule                         | when to run the Achilles job. See <https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/#cron-schedule-syntax>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <code>"@daily"</code>                                                                                                                                                                 |
| achilles.schemas.cdm                      | name of the schema containing the OMOP CDM. Equivalent to the Achilles `ACHILLES_CDM_SCHEMA` env var.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | <code>"synpuf_cdm"</code>                                                                                                                                                             |
| achilles.schemas.vocab                    | name of the schema containing the vocabulary. Equivalent to the Achilles `ACHILLES_VOCAB_SCHEMA` env var.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <code>"synpuf_vocab"</code>                                                                                                                                                           |
| achilles.schemas.res                      | name of the schema containing the cohort generation results. Equivalent to the Achilles `ACHILLES_RES_SCHEMA` env var.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | <code>"synpuf_results"</code>                                                                                                                                                         |
| achilles.successfulJobsHistoryLimit       | The number of successful finished jobs to retain. Value must be non-negative integer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | <code>3</code>                                                                                                                                                                        |
| achilles.failedJobsHistoryLimit           | The number of failed finished jobs to retain. Value must be non-negative integer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <code>1</code>                                                                                                                                                                        |
| achilles.concurrencyPolicy                | Specifies how to treat concurrent executions of a Job. Valid values are: - "Allow" (default): allows CronJobs to run concurrently; - "Forbid": forbids concurrent runs, skipping next run if previous run hasn't finished yet; - "Replace": cancels currently running job and replaces it with a new one                                                                                                                                                                                                                                                                                                                                                         | <code>Forbid</code>                                                                                                                                                                   |
| achilles.cdmVersion                       | version of the CDM. Equivalent to the Achilles `ACHILLES_CDM_VERSION` env var.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>"5.3"</code>                                                                                                                                                                    |
| achilles.sourceName                       | the CDM source name. Equivalent to the Achilles `ACHILLES_SOURCE` env var.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <code>"synpuf-5.3.1"</code>                                                                                                                                                           |
| achilles.extraEnv                         | extra environment variables to pass to the Achilles container                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <code>[]</code>                                                                                                                                                                       |
| achilles.podAnnotations                   | annotations applied to the pod managed by this CronJob                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | <code>{}</code>                                                                                                                                                                       |
| ingress.enabled                           | whether to create an Ingress to expose the Atlas web interface                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <code>false</code>                                                                                                                                                                    |
| ingress.annotations                       | provide any additional annotations which may be required. Evaluated as a template.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | <code>{}</code>                                                                                                                                                                       |
| ingress.tls                               | ingress TLS config                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | <code>[]</code>                                                                                                                                                                       |

Specify each parameter using the `--set key=value[,key=value]` argument to `helm install`. For example:

```console
$ helm install ohdsi chgl/ohdsi -n ohdsi --set postgresql.auth.database="ohdsi"
```

Alternatively, a YAML file that specifies the values for the parameters can be provided while
installing the chart. For example:

```console
$ helm install ohdsi chgl/ohdsi -n ohdsi --values values.yaml
```

## Initialize the CDM using a custom container

The `cdmInitJob` configuration parameter can be used to configure a custom container that is run as a Kubernetes Job
when the chart is installed. See [templates/cdm-init-job.yaml](templates/cdm-init-job.yaml) for a list of default environment
variables passed to the container.

As an example, here's one such container's `entrypoint.sh` and the associated Dockerfile below:

```sh
#!/bin/bash
set -e

OMOP_INIT_BASE_DIR="/opt/omop-init"

SOURCES_DIR="$OMOP_INIT_BASE_DIR/sources"
VOCABS_DIR="$OMOP_INIT_BASE_DIR/vocabs"
SCHEMAS_DIR="$OMOP_INIT_BASE_DIR/schemas"
POSTINIT_DIR="$OMOP_INIT_BASE_DIR/postinit"

WEBAPI_URL=${WEBAPI_URL:?"WEBAPI_URL required but not set"}
PGPASSWORD=${PGPASSWORD:?"PGPASSWORD required but not set"}
PGHOST=${PGHOST:?"PGHOST required but not set"}

export PGDATABASE=${PGDATABASE:-"ohdsi"}
export PGUSER=${PGUSER:-"postgres"}
export PGPORT=${PGPORT:-"5432"}

CDM_DIR="$VOCABS_DIR/cdm"

mkdir -p "$VOCABS_DIR"

echo "$(date): Extracting CDM vocabs"
tar -xzvf "$SOURCES_DIR/cdm.tar.gz" -C "$VOCABS_DIR/"

echo "$(date): Checking if Postgres @ $PGHOST:$PGPORT is up"
until psql -c "select 1"; do
    echo "$(date): Waiting for Postgres to be up"
    sleep 5
done
echo "$(date): Postgres is up"

echo "$(date): Creating Schema"
for SQL_FILE in init_omop/*; do
    echo "$(date): Applying $SQL_FILE"
    psql -f "$SQL_FILE"
done

echo "$(date): Copying vocabulary"

psql <<-EOSQL
    \COPY cdm.drug_strength FROM '$CDM_DIR/DRUG_STRENGTH.csv' WITH DELIMITER E'\t' CSV HEADER QUOTE E'\b';
    \COPY cdm.concept FROM '$CDM_DIR/CONCEPT.csv' WITH DELIMITER E'\t' CSV HEADER QUOTE E'\b';
    \COPY cdm.concept_relationship FROM '$CDM_DIR/CONCEPT_RELATIONSHIP.csv' WITH DELIMITER E'\t' CSV HEADER QUOTE E'\b';
    \COPY cdm.concept_ancestor FROM '$CDM_DIR/CONCEPT_ANCESTOR.csv' WITH DELIMITER E'\t' CSV HEADER QUOTE E'\b';
    \COPY cdm.concept_synonym FROM '$CDM_DIR/CONCEPT_SYNONYM.csv' WITH DELIMITER E'\t' CSV HEADER QUOTE E'\b';
    \COPY cdm.vocabulary FROM '$CDM_DIR/VOCABULARY.csv' WITH DELIMITER E'\t' CSV HEADER QUOTE E'\b';
    \COPY cdm.relationship FROM '$CDM_DIR/RELATIONSHIP.csv' WITH DELIMITER E'\t' CSV HEADER QUOTE E'\b';
    \COPY cdm.concept_class FROM '$CDM_DIR/CONCEPT_CLASS.csv' WITH DELIMITER E'\t' CSV HEADER QUOTE E'\b';
    \COPY cdm.domain FROM '$CDM_DIR/DOMAIN.csv' WITH DELIMITER E'\t' CSV HEADER QUOTE E'\b';
EOSQL

echo "$(date): Creating DB indices"
PGOPTIONS=--search_path=cdm psql -f "$POSTINIT_DIR/indexes.sql"

echo "$(date): Creating DB constraints"
PGOPTIONS=--search_path=cdm psql -f "$POSTINIT_DIR/constraints.sql"

echo "$(date): Creating CDM results tables"
PGOPTIONS=--search_path=cdm psql -f "$POSTINIT_DIR/restabs_cdm.sql"

echo "$(date): Waiting for WebAPI @ $WEBAPI_URL to be up"
until [ "$(curl -s -o /dev/null -L -w '%{http_code}' "$WEBAPI_URL/info")" == "200" ]; do
    echo "$(date): Waiting for WebAPI to be up"
    sleep 5
done


# This is better solved by invoking the WebAPI dynamically instead
echo "$(date): Updating OHDSI WebAPI CDM sources"
psql <<-EOSQL
    INSERT INTO ohdsi.source(source_id, source_name, source_key, source_connection, username, password, source_dialect)
    VALUES (1, 'CDM V5.3.1 Database', 'CDMV5', 'jdbc:postgresql://${PGHOST}:${PGPORT}/${PGDATABASE}', '$PGUSER', '$PGPASSWORD', 'postgresql');

    INSERT INTO ohdsi.source_daimon(source_daimon_id, source_id, daimon_type, table_qualifier, priority)
    VALUES (5, 1, 0, 'cdm', 2);

    INSERT INTO ohdsi.source_daimon(source_daimon_id, source_id, daimon_type, table_qualifier, priority)
    VALUES (6, 1, 1, 'cdm', 2);

    INSERT INTO ohdsi.source_daimon(source_daimon_id, source_id, daimon_type, table_qualifier, priority)
    VALUES (7, 1, 2, 'cdm_results', 2);

    INSERT INTO ohdsi.source_daimon(source_daimon_id, source_id, daimon_type, table_qualifier, priority)
    VALUES (8, 1, 3, 'cdm_results', 2);
EOSQL

echo "$(date): Refreshing sources"
curl -s -L -o /dev/null "$WEBAPI_URL/source/refresh"

echo "$(date): Completed initialization."
exit 0
```

```Dockerfile
FROM alpine:3.12
# hadolint ignore=DL3018
RUN apk --no-cache --repository=http://dl-cdn.alpinelinux.org/alpine/edge/main add \
    curl \
    bash \
    postgresql-client

WORKDIR /opt/omop-init/sources

ARG CDM_URL=https://<s3-url>/tar-gz-containing-cdm-vocabulary
RUN curl -LSs ${CDM_URL} \
    -o cdm.tar.gz

WORKDIR /opt/omop-init
RUN chown -R 10001 .

# contains the CDM schema SQLs (fetching this within the Dockerfile may be cleaner)
COPY --chown=10001:10001 init_omop init_omop/
# scripts to setup custom schema names
COPY --chown=10001:10001 init_scripts init_scripts/
# scripts to apply indexes
COPY --chown=10001:10001 postinit postinit/
# the entrypoint.sh from above
COPY --chown=10001:10001 entrypoint.sh /entrypoint.sh

USER 10001
ENTRYPOINT [ "/bin/bash" ]
CMD [ "/entrypoint.sh" ]
```

## Override config-local.js for Atlas

To use a custom config-local.js file to configure Atlas, you can use the `atlas.config.local` key:

```yaml
atlas:
  # makes sure the WEBAPI_URL env var isn't automatically set to ingress.host
  # this is needed when setting config.local
  constructWebApiUrlFromIngress: false
  config:
    local: |
      define([], function () {
        var configLocal = {};

        // clearing local storage otherwise source cache will obscure the override settings
        localStorage.clear();

        var getUrl = window.location;
        var baseUrl = getUrl.protocol + "//" + getUrl.host;

        // WebAPI
        configLocal.api = {
          name: "OHDSI",
          url: baseUrl + "/WebAPI/",
        };

        configLocal.cohortComparisonResultsEnabled = false;
        configLocal.userAuthenticationEnabled = true;
        configLocal.plpResultsEnabled = false;

        configLocal.authProviders = [
          {
            name: "OpenID",
            url: "user/login/openid",
            ajax: false,
            icon: "fa fa-openid",
          },
        ];

        return configLocal;
      });
```

## Securing Atlas using OpenID Connect

You can secure the access to the WebAPI and consequently limit what Atlas users can and cannot do.

See <https://github.com/OHDSI/WebAPI/wiki/Security-Configuration> and <https://github.com/OHDSI/WebAPI/wiki/Atlas-Security> for details.

As an example, here's a values.yaml file that enables OpenID Connect authentication (tested using Keycloak):

```yaml
ingress:
  enabled: true
  hosts:
    - host: omop.example.com
  tls:
    - secretName: omop.example.com-tls
      hosts:
        - omop.example.com
atlas:
  # makes sure the WEBAPI_URL env var isn't automatically set to ingress.host
  # this needed is when specifying config.local
  constructWebApiUrlFromIngress: false
  config:
    local: |
      define([], function () {
        var configLocal = {};

        // clearing local storage otherwise source cache will obscure the override settings
        localStorage.clear();

        var getUrl = window.location;
        var baseUrl = getUrl.protocol + "//" + getUrl.host;

        // WebAPI
        configLocal.api = {
          name: "OHDSI",
          url: baseUrl + "/WebAPI/",
        };

        configLocal.cohortComparisonResultsEnabled = false;
        configLocal.userAuthenticationEnabled = true;
        configLocal.plpResultsEnabled = false;

        configLocal.authProviders = [
          {
            name: "OpenID Connect",
            url: "user/login/openid",
            ajax: false,
            icon: "fa fa-openid",
          },
        ];

        return configLocal;
      });
webApi:
  auth:
    openid:
      enabled: true
      clientId: "ohdsi"
      clientSecret: "a5f55a03-ca7d-4a52-a352-498defb2f6fa"
      # Required. Points to the openid-configuration endpoint of the provider,
      oidUrl: "https://auth.example.com/auth/realms/OHDSI/.well-known/openid-configuration"
      # URL including the OHDSI WebAPI oauth callback, e.g. `https://example.com/WebAPI/user/oauth/callback`.
      # If unset, a URL is constructed from `ingress.hosts[0]`
      callbackApi: ""
      # URL including the callback URL referring to the ATLAS UI, e.g. `https://example.com/atlas/index.html#/welcome/`.
      # If unset, a URL is constructed from `ingress.hosts[0]`
      callbackUI: ""
      # URL to be redirected to when logging out, e.g. `https://example.com/atlas/index.html#/welcome/`.
      # If unset, a URL is constructed from `ingress.hosts[0]`
      logoutUrl: ""
      # OpenID redirect URL, e.g. `https://example.com/atlas/index.html#/welcome/null`
      # If unset, a URL is constructed from `ingress.hosts[0]`
      redirectUrl: ""
```

Make sure to give any logged-in user the appropriate permissions by following: <https://github.com/OHDSI/WebAPI/wiki/Atlas-Security#defining-an-administrator>.
